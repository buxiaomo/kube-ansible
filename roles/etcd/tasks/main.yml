---
# tasks file for etcd
- name: Install the Etcd binary
  copy: 
    src: '{{ item }}'
    dest: /usr/local/bin/
    mode: 0755
    owner: root
    group: root
  with_items:
    - etcd
    - etcdctl

- name: Create data directory
  file: 
    name: '{{ kubernetes.etcd.datadir }}'
    state: directory
    mode: '0755'

- name: Create certificate directory
  file: 
    name: '{{ ca.etcd.location }}'
    state: directory
    mode: '0755'

- name: Distribution of certificate
  copy: 
    src: '{{ ca.etcd.location }}/{{ item }}'
    dest: '{{ ca.etcd.location }}'
    owner: root
    group: root
  with_items:
    - ca.crt
    - server.crt
    - server.key
    - peer.crt
    - peer.key

- name: Install systemd file
  template: 
    src: etcd.service.j2
    dest: /etc/systemd/system/etcd.service

- name: Start the service
  systemd:
    name: etcd
    state: restarted
    enabled: yes
    daemon_reload: yes